# Notes:
#   - Minimal appveyor.yml file is an empty file. All sections are optional.
#   - Indent each level of configuration with 2 spaces. Do not use tabs!
#   - All section names are case-sensitive.
#   - Section names should be unique on each level.

# Reference: https://www.appveyor.com/docs/appveyor-yml/

# Majority of this is taken from 
# - https://dotnetcore.gaprogman.com/2017/06/08/continuous-integration-and-appveyor/
# - https://stefanscherer.github.io/setup-windows-docker-ci-appveyor/

version: 1.0.{build}

# Do not build on tags (GitHub and BitBucket)
skip_tags: true

# Do not trigger two builds when pushing to a branch with an open pull request
skip_branch_with_pr: true

# Build worker image (VM template)
image: Visual Studio 2017

configuration: Release

environment:
  DOCKER_USER:
    secure: DH/F3YmCTtoML7jh0N72CA==
  DOCKER_PASS:
    secure: rwHHmt2wdZkHdQTKNJm48EVaGnXWvq4Fqfpxwy85UWQ=

init:  
  - cmd: git config --global core.autocrlf true

before_build:
  # Display .NET Core version
  - cmd: dotnet --version
  # Display minimal restore text
  - cmd: dotnet restore --verbosity m

build_script:
  - cmd: cd src/Basket.Api
  - cmd: dotnet publish -c Release -o out Basket.Api.csproj
  - cmd: docker build -t jameslappin/basketapi .
  - cmd: cd ../..

test_script:
  - cmd: dotnet build src/Basket.UnitTests/Basket.UnitTests.csproj
  - cmd: dotnet test src/Basket.UnitTests/Basket.UnitTests.csproj

deploy_script:
  - cmd echo "the secure varible is $env:DOCKER_USER"
  - docker login -u="$env:DOCKER_USER" -p='$env:DOCKER_PASS'
  - docker push james/basketapi